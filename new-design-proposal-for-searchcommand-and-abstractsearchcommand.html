
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
  <HEAD>
    <LINK type="text/css" rel="stylesheet" href="resources/space.css">
    <STYLE type="text/css">

#PageContent {
	text-align: left;
	background-color: #fff;
	padding: 0px;
	margin: 0px;
    padding-bottom:20px; 
}

#TopTable {
    height: 104px; width: 100%; 
    background-image: url(/sunrise3.JPG); 
    background-repeat: no-repeat; 
    background-position: center;
}

div > #TopTable {
    position: fixed; z-index: 1; 
}

div > #PageContent {
    position: relative; 
    top: 114px;
}

      .footer {
        background-image:      url('/images/border/border_bottom.gif');
        background-repeat:     repeat-x;
        background-position:   left top;
        padding-top:           4px;
        color:                 #666;
      }
body, p, td, table, tr, .bodytext, .stepfield {
  font-family:          Trebuchet MS, Tahoma, sans-serif;
  font-size:            14px;
  margin:               0px;
  padding:              0px;
  padding-right:30px;
}
#leftColumn{
  float: left; 
  align: left; 
  text-align: left; 
  width: 13%; 
  border-right: solid lightgrey; 
  border-right-width:1px;
}
#leftColumn h5{
  text-decoration: none;
  color: #6B6965;
  font-size:            18px;
  font-weight: bold;
}
#leftColumn li a{
  text-decoration: none;
  color: #6B6965;
  font-weight: bold;
}
#leftColumn a:hover, #leftColumn a.active  {
  color: #1678C4;
  background-color: #F7EEDB;
}
#TopTable a{
  text-decoration: none;
  font-weight: bold;
}
    </STYLE>
    <SCRIPT type="text/javascript" language="javascript">
      var hide = null;
      var show = null;
      var children = null;

      function init() {

        /* Children initialization */
        hide = document.getElementById('hide');
        show = document.getElementById('show');
        children = document.all != null ?
                   document.all['children'] :
                   document.getElementById('children');
        if (children != null) {
          children.style.display = 'none';
          show.style.display = 'inline';
          hide.style.display = 'none';
        }
      }

      function showChildren() {
        children.style.display = 'block';
        show.style.display = 'none';
        hide.style.display = 'inline';
      }

      function hideChildren() {
        children.style.display = 'none';
        show.style.display = 'inline';
        hide.style.display = 'none';
      }
    </SCRIPT>
    <TITLE>New design proposal for SearchCommand and AbstractSearchCommand</TITLE>
  <META http-equiv="Content-Type" content="text/html;charset=UTF-8"></HEAD>
  <BODY onload="init()" style="background-color: #fff;">
<DIV>
    <TABLE id="TopTable" border="0" cellpadding="2" cellspacing="0" width="100%">
      <TR valign="bottom">
        <TD align="left" valign="bottom" class="topBarDiv" align="left" nowrap="">
          <!--img src="https://michaelsembwever.github.io/Sesat/sesat- black- logo.png" border="0"-->&nbsp;<A href="home.html" title="Sesat">Sesat</A>&nbsp;&gt;&nbsp;<A href="docs-support.html" title="Docs + Support">Docs + Support</A>&nbsp;&gt;&nbsp;<A href="architecture-overview.html" title="Architecture Overview">Architecture Overview</A>&nbsp;&gt;&nbsp;<A href="design-proposals.html" title="Design Proposals">Design Proposals</A>&nbsp;&gt;&nbsp;<A href="" title="New design proposal for SearchCommand and AbstractSearchCommand">New design proposal for SearchCommand and AbstractSearchCommand</A>
        </TD>
        <TD align="right" valign="bottom" nowrap="">
          <FORM name="search" action="http://sesam.com/search/" method="get" onsubmit="getElementById('searchformq').value = getElementById('searchformq').value + ' site:sesat.no'; return true">
            <INPUT type="text" name="q" maxlength="255" value="" id="searchformq">        
            <INPUT type="submit" name="btnG" value="Search">
          </FORM>
        </TD>
      </TR> 
    </TABLE>
    <DIV id="PageContent">

<DIV id="leftColumn">
<H5 style="margin-top: -2px;">Get Sesat</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/product-whitepaper.html">
What is Sesat?</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/download.html" style="decorator-style: none;">
Download</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/kernel-feature-list.html">
Features</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/showcases-sesamno.html">
Screenshots</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/free-software-license.html">
License</A>
</LI>
</UL>

<H5>Documentation</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/development-guidelines.html">
Getting Started</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/tutorial-building-sesamcom.html">
Sesam.com tutorial</A>
</LI>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/faq.html">
FAQ</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
&nbsp;...<A href="https://michaelsembwever.github.io/Sesat/docs-support.html">more</A>
</LI>
</UL>
<H5>Development</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/kernel-roadmap.html">
Roadmap</A>
</LI>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/svn/">
Subversion Repository</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/getting-help.html">
Mailing lists</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/scarab/issues">
Issues</A>
</LI>
<!--LI class="none" style="list- style: none; margin- left: - 30px;">
<A href="https://michaelsembwever.github.io/Sesat/hudson/">
Hudson
</A>
</LI>
<LI class="none" style="list- style: none; margin- left: - 30px;">
<A href="https://michaelsembwever.github.io/Sesat/source/">
OpenGrok
</A>
</LI-->
</UL>

<H5>Projects</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/projects/sesat-kernel/">Search Framework</A><BR>
<A href="https://michaelsembwever.github.io/Sesat/projects/sesat-kernel/sesat-core-api">Search Library</A><BR>
<A href="https://michaelsembwever.github.io/Sesat/projects/sesat-kernel/sesat-mojo/">Mojo</A><BR>
<A href="https://michaelsembwever.github.io/Sesat/projects/sesat-admin/sesat-user">User Service</A>
</LI>
</UL>

<H5>Commons</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="http://commons-ioc.sourceforge.net/">Contextual IoC</A><BR>
<A href="https://michaelsembwever.github.io/Sesat/projects/sesat-commons/commons-interpreter/">Interpreter</A><BR>
<A href="http://commons-reflect.sourceforge.net/">Reflection</A><BR>
<A href="http://commons-ref-map.sourceforge.net/">Reference Map</A><BR>
<A href="http://commons-visitor.sourceforge.net/">Visitor</A><BR>
</LI>
</UL>


<H5>Sitemap</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Sesat/sitemap.html">Sitemap</A><BR>
</LI>
</UL>
</DIV>

      <DIV class="pagecontent" style="width: 83%; float: right;">
        <DIV class="wiki-content">
          <H1><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-DesignproposalforSearchCommandandAbstractSearchCommand"></A>Design proposal for SearchCommand and AbstractSearchCommand</H1>

<P><A href="https://michaelsembwever.github.io/Sesat/scarab/issues/id/SKER2149" rel="nofollow">Issue SKER2149:  (Divide &amp; Conquer AbstractSearchCommand to delegates)</A></P>

<DIV>
<UL>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-DesignproposalforSearchCommandandAbstractSearchCommand">Design proposal for SearchCommand and AbstractSearchCommand</A></LI>
<UL>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Currentproblems">Current problems</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-CurrentAPI">Current API</A></LI>
<UL>
<UL>
<UL>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-SearchCommandContext">SearchCommand Context</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-SearchCommandConcerns">SearchCommand Concerns</A></LI>
</UL>
</UL>
</UL>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Solutions">Solutions</A></LI>
<UL>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Executionhandling">Execution handling</A></LI>
<UL>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Executionhandlinggenerics">Execution handling generics</A></LI>
</UL>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Parameters">Parameters</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-CommandapplicableQuery">Command applicable Query</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-CommandQueryconstruction">Command Query construction</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-CommandXorClausehandling">Command XorClause handling</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-ReservedWords">Reserved Words</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Fieldedclause%2528%2526Custom%2529filters">Fielded clause (&amp; Custom) filters</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Customfilters">Custom filters</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Streammanipulation%2526ResultConstruction">Stream manipulation &amp; Result Construction</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Collapsing%2528%2526Clustering%2529">Collapsing (&amp; Clustering)</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Modifiers">Modifiers</A></LI>
    <LI><A href="#NewdesignproposalforSearchCommandandAbstractSearchCommand-Utilitybehavior">Utility behavior</A></LI>
</UL>
</UL>
</UL></DIV>

<H2><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Currentproblems"></A>Current problems</H2>
<UL>
	<LI>combination of various concern implementations leads to excessive subclass count or restrictive subclass implementation, eg simple or advanced filter combined with simple or advanced query gives four possible implementations with 100% duplication,</LI>
	<LI>poor parameter handling, offset, sortby, results-to-return, etc</LI>
	<LI>too many visitors, or unclear of various responsibilities involved,</LI>
	<LI>filter confusion: fielded clauses filters versus custom filters versus QueryTransformer.getFilter()</LI>
	<LI>...</LI>
</UL>


<H2><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-CurrentAPI"></A>Current API</H2>

<H5><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-SearchCommandContext"></A>SearchCommand Context</H5>

<P>ResourceContext<BR>
DataModelContext<BR>
SearchConfigurationContext<BR>
TokenEvaluationEngineContext</P>

<H5><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-SearchCommandConcerns"></A>SearchCommand Concerns</H5>

<P>Currently search commands have the methods:</P>
<TABLE class="sectionMacro" border="0" cellpadding="5" cellspacing="0" width="100%"><TBODY><TR>
<TD class="confluenceTd" valign="top">
<H6><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-SearchCommand"></A>SearchCommand</H6>

<P>getSearchConfiguration()<BR>
call()<BR>
handleCancellation()<BR>
isPaginated()<BR>
isUserSortable()</P></TD>
<TD class="confluenceTd" valign="top">
<H6><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-AbstractSearchCommand"></A>AbstractSearchCommand</H6>

<P>execute()<BR>
isCancelled()<BR>
performQueryTransformation()<BR>
performExecution()<BR>
performResultHandling()<BR>
getFilter()<BR>
setFilter()<BR>
getAdditionalFilter()<BR>
visitImpl<IMG class="emoticon" src="http://confluence.finn.no/images/icons/emoticons/star_yellow.gif" height="16" width="16" align="absmiddle" alt="" border="0"><BR>
visitXorClause(..)<BR>
getSearchResult(..)<BR>
getOffset()<BR>
isPaginated()<BR>
geUserSortBy()<BR>
isUserSortable()<BR>
getParameter(String)<BR>
getSingleParameter(String)<BR>
getQuery()<BR>
getQueryRepresentation(Query)<BR>
getTransformedTerm(Clause)<BR>
getTransformedTerms()<BR>
initialiseTransformedTerms()<BR>
appendToQueryRepresentation(String)<BR>
insertToQueryRepresentation(String)<BR>
getQueryRepresentationLength()<BR>
escapeFieldedLeaf(LeafClause)<BR>
isEmptyLeaf(Clause)<BR>
getFieldFilter(LeafClause)<BR>
getTransformedQuery()<BR>
getTransformedQuerySesamSyntax()<BR>
setTransformedQuerySesamSyntax()<BR>
newSesamSyntaxQueryBuilder()<BR>
updateTransformedQuerySesamSyntax()<BR>
getEngine() <BR>
statisticInfo(String)<BR>
MapVisitor<BR>
FilterVisitor<BR>
SesamSyntaxQueryBuilder</P></TD>
<TD class="confluenceTd" valign="top">
<H6><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-AbstractXmlSearchCommand"></A>AbstractXmlSearchCommand</H6>

<P>getResultsToReturn()<BR>
getXmlResult()<BR>
getHttpReader()</P></TD>
<TD class="confluenceTd" valign="top">
<H6><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-AbstractSimpleFastSearchCommand"></A>AbstractSimpleFastSearchCommand</H6>

<P>createnavigationFilterStrings()<BR>
setSearchEngineFactory(IFastSearchEngineFactory)<BR>
addNavigatedTo(String)<BR>
getNavigators()<BR>
getResultsToReturn()<BR>
getSearchEngine()<BR>
getSortBy()<BR>
setAdditionalParameters(ISearchParameters)<BR>
collectSpellingSuggestions(IQueryResult, FastSearchResult)<BR>
createSpellingSuggestion(String)<BR>
collectResults(IQueryResult)<BR>
createResultItem(IDocumentSummary)<BR>
createQuery()<BR>
getDynmicParams(Map,String,String)<BR>
getNavigatorsString()<BR>
flattenNavigators(Collection&lt;Navigator&gt;, Navigator)<BR>
collectModifiers(IQueryResult,FastSearchResult)<BR>
collectModifier(String,IQueryResult,FastSearchResult)<BR>
getModifierComparator(Navigator)<BR>
createProperNameSuggestion(String)<BR>
collectRelevantQueries(IQueryResult,FastSearchResult)</P></TD>
<TD class="confluenceTd" valign="top">
<H6><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-AbstractESPFastSearchCommand"></A>AbstractESPFastSearchCommand</H6>

<P>ReservedWord enum<BR>
appendFilter(String,String)<BR>
getSortBy()<BR>
modifyQuery(IQuery)<BR>
createSearchResult(IQueryResult)<BR>
getIQueryResult()<BR>
isNavigatable()</P>


<H6><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-NavigatableESPFastCommand"></A>NavigatableESPFastCommand</H6>

<P>createNavigationFilterStrings()<BR>
addNavigatedTo(String)<BR>
getNavigatedTo(String)<BR>
getNavigatedValues()<BR>
getNavigatedValue(String)<BR>
getNavigatedTo()<BR>
collectModifiers(IQueryResult, FastSearchResult)<BR>
collectModifier(String,IQueryResult, FastSearchResult)<BR>
getModifierComparator(Navigator)</P>


<H6><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-NewsEspSearchCommand"></A>NewsEspSearchCommand</H6>

<P>addMedium(Clause)<BR>
createCollapsedResults(NewsEspCommandConfig,int,IQueryResult)<BR>
addResult(NewsEspCommandConfig,ResultList,IDocumentSummary)</P>


<H6><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-NewsClusteringESPFastCommand"></A>NewsClusteringESPFastCommand</H6>

<P>createClusteringSearchResult(ClusteringEspFastCommandConfig,int,IQueryResult)</P></TD></TR></TBODY></TABLE>

<P>A number of clear concerns can be seen:</P>
<UL>
	<LI>Execution handling <TT>call() execute() handleCancellation() isCancelled() performQueryTransformation() performExecution() performResultHandling()</TT></LI>
	<LI>Parameters <TT>getParameter(String) getSingleParameter(String)</TT>
	<UL>
		<LI>Result list size <TT>getResultsToReturn()</TT></LI>
		<LI>Pagination &amp; Offset <TT>isPaginated() getOffset()</TT></LI>
		<LI>Sorting <TT>isUserSortable() getUserSortBy() getSortBy()</TT></LI>
	</UL>
	</LI>
	<LI>Command applicable Query <TT>getQuery()</TT></LI>
	<LI>Command Query construction --&gt; internal visitor <TT>visitImpl(&#42;) getTransformedTerms() getTransformedTerm(Clause) initialiseTransformedTerms() appendToQueryRepresentation(String) insertToQueryRepresentation(String) getQueryRepresentationLength() escapeFieldedLeaf(LeafClause) isEmptyLeaf(Clause) getTransformedQuery() MapVisitor</TT></LI>
	<LI>Command XorClause handling <TT>visitXorClause(XorClause)</TT></LI>
	<LI>Filter (fielded clauses) <TT>getAdditionalFilter() FilterVisitor</TT></LI>
	<LI>Custom Filters <TT>getFilter() setFilter() QueryTransformer.getFilter()</TT></LI>
	<LI>Modifiers (Domain Navigators)</LI>
	<LI>Stream handling/manipulating</LI>
	<LI>Reserved words</LI>
	<LI>Collapsing (&amp; Clustering)</LI>
	<LI>Suggestions: Spelling, ProperName, Relevant queries</LI>
	<LI>Result Construction</LI>
	<LI>Utility (almost static methods <IMG class="emoticon" src="http://confluence.finn.no/images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"> <TT>getSearchResult(..)</TT></LI>
</UL>


<H2><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Solutions"></A>Solutions</H2>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Executionhandling"></A>Execution handling</H3>

<P>Can remain as is.<BR>
This is in fact a concrete implementation of Callable's &quot;ResultList&lt;ResultItem&gt; call()&quot; method by AbstractSearchCommand, and it introduces the concepts of QueryTransformation, Execution, and Result Handling. AbstractSearchCommand express solely this, everything else it does should be moved out.</P>

<P><B>ToDo</B> The SearchConfiguration classes SearchConfiguration, AbstractSearchConfiguration, and CommandConfig do not match the behaviour separation defined between SearchCommand and AbstractSearchCommand. For example, a brand new fresh SearchCommand implementation requires a SearchConfiguration with little of the properties actually defined in SearchConfiguration.</P>

<H4><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Executionhandlinggenerics"></A>Execution handling generics</H4>
<P>Although the use of generics requires a review. Using generics in method signatures intended to be subclassed is something a little more complicated to design properly and IMHO was not done correctly the first time.<BR>
For example:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">interface</SPAN> SearchCommand <SPAN class="code-keyword">extends</SPAN> Callable&lt;ResultList&lt;? <SPAN class="code-keyword">extends</SPAN> ResultItem&gt;&gt; 
<SPAN class="code-keyword">public</SPAN> <SPAN class="code-keyword">abstract</SPAN> ResultList&lt;? <SPAN class="code-keyword">extends</SPAN> ResultItem&gt; execute()
<SPAN class="code-keyword">public</SPAN> ResultList&lt;? <SPAN class="code-keyword">extends</SPAN> ResultItem&gt; call()
<SPAN class="code-keyword">protected</SPAN> <SPAN class="code-keyword">final</SPAN> ResultList&lt;? <SPAN class="code-keyword">extends</SPAN> ResultItem&gt; getSearchResult(<SPAN class="code-object">String</SPAN>, DataModel)
<SPAN class="code-keyword">protected</SPAN> <SPAN class="code-keyword">final</SPAN> ResultList&lt;? <SPAN class="code-keyword">extends</SPAN> ResultItem&gt; performExecution()
<SPAN class="code-keyword">protected</SPAN> <SPAN class="code-keyword">final</SPAN> void performResultHandling(<SPAN class="code-keyword">final</SPAN> ResultList&lt;? <SPAN class="code-keyword">extends</SPAN> ResultItem&gt; result)
</PRE>
</DIV></DIV>
<P>No subclass can actually subclass these methods and provide exact generics to the signatures because each command, for example, returns a BasicResultList upon cancellation or handled internal checked exception.</P>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Parameters"></A>Parameters</H3>

<P>Parameters typically have three sources, and they first found used: a url parameter, a user parameter, the command's configured parameter.<BR>
Sometimes (eg userSortBy and pagination) the configuration actually comes from the presentation layer. The command's configuration here must simply point to where in the presentation layer this configuration can be found. Strictly speaking the domain ayer should be isolated from the presentation layer but here we access only the presentation layer's configuration through the datamodel.</P>

<P>ResultToReturn is an interesting example. It should be both overridable from url and user parameters. But the configuration exist in both the presentation layer and the domain layer. The domain layer's only responsibility is to ensure <B>at least</B> the amount of results are returned that the presentation layer wants. Up until now its just been presumed that the command's configuration is hardcoded to a value larger than any possible presentation value.</P>

<P>An example implementation can be viewed here: <A href="searchcommandparameter-code-example.html" title="SearchCommandParameter code example">SearchCommandParameter code example</A>.</P>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-CommandapplicableQuery"></A>Command applicable Query</H3>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-CommandQueryconstruction"></A>Command Query construction</H3>

<P>Magnus Eklund's solution follows:</P>
<BLOCKQUOTE><P>Introduce a new interface called QueryBuilder. Query Builders are used to transform the query object into a string representation.</P>
<UL>
	<LI>Remove &quot;extends AbstractReflectionVisitor&quot; from AbstractSearchCommand.</LI>
	<LI>New interface QueryBuilder</LI>
	<LI>Add property queryBuilder to SearchConfiguration to hold the FQN of a QueryBuilder class. This property will correspond to a &lt;queryBuilder&gt;-tag in modes.xml to allow for configuration of the query builder itself. (e.g. &lt;queryBuilder class=&quot;no.sesat.search.mode.command.query.PrefixQueryBuilder&quot; supportsAndNot=&quot;false&quot; /&gt;)</LI>
	<LI>Create QueryBuilder implementations:
	<UL>
		<LI>PrefixQueryBuilder</LI>
		<LI>SesamQueryBuilder</LI>
		<LI>InfixQueryBuilder.</LI>
		<LI>Fast4QueryBuilder (if needed, should be possible to configure one of the above to produce suitable syntax)</LI>
		<LI>Fast5QueryBuilder (if needed, should be possible to configure one of the above to produce suitable syntax)</LI>
	</UL>
	</LI>
</UL>
</BLOCKQUOTE>

<P>These would still visitors over the query but transforming from the transformedMap into a string representation.<BR>
The transformedMap is the mutable state of each clause through the search command's query transformations.<BR>
QueryBuilder also needs to have an API to deal with XorClauses, ReservedWords, and supported filter clauses. The definition of these things would be supplied through the context.</P>

<P><B>Backward Compatibility</B> could be helped by, when no QueryBuilder is specified, creating a proxy against the search command and using it presuming it contains all the QueryBuilder methods required. <BR>
The alternative backard compatibility would be to refactor AbstractSearchCommand to DeprecatedSearchCommand, so that existing search commands work as is. Problem here is that we'd end up with a score of DeprecatedXyzSearchCommand classes as many of the subclasses are rewritten to the new AbstractSearchCommand implementation.</P>

<P>Example starting implementation can be read <A href="querybuilder-code-example.html" title="QueryBuilder code example">QueryBuilder code example</A>.</P>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-CommandXorClausehandling"></A>Command XorClause handling</H3>

<P>This can stay how it is. It must be provided to any QueryBuilder's context.</P>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-ReservedWords"></A>Reserved Words</H3>

<P>Only exists in AbstractESPFastSearchCommand. Should be formalised and brought down to the SearchCommand interface. <BR>
Since the enumeration belongs to a particular SearchCommand implementation the enumeration should also return how each item is to be escaped in any query.<BR>
It must be provided to any QueryBuilder's context.</P>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Fieldedclause%28%26Custom%29filters"></A>Fielded clause (&amp; Custom) filters</H3>

<P>Where filters (included custom filters) go is a prickly trick. Some command's have the filter simply appended to the query, while others have no notion of a filter at all.<BR>
Worse yet is that some filter must go into the query and others defined as separate parameters.</P>

<P>Should the transformedMap state be made available to multiple QueryBuilder within any one request, so that a command that request filters in a separate parameter to the query could run two separate QueryBuilders. The query QueryBuilder would ignore filters, the filter QueryBuilder would ignore non-filter terms. Exaggerating it, commands that requested <EM>each</EM> filter in a separate parameter could have multiple filter QueryBuilders each ignoring everything but the one filter it is responsible for.<BR>
But how does this deal with custom filters that come from the configuration, not the query. Should each custom filter be deserialised into a Query tree/object and QueryBuilders be able to visitor multiple query trees???</P>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Customfilters"></A>Custom filters</H3>


<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Streammanipulation%26ResultConstruction"></A>Stream manipulation &amp; Result Construction</H3>

<P><B>Stream manipulation</B> exists in AbstractXmlSearchCommand. Should be formalised. A little awkward, for example FAST commands work against a java api.<BR>
Could be defined in auxiliary interfaces, eg RestfulSearchCommand, StreamReaderSearchCommand, that could be mixed and matched.<BR>
Example implementation can be read <A href="stream-manipulation-code-examples.html" title="Stream manipulation code examples">Stream manipulation code examples</A>.
<BR clear="all"> <BR clear="all">
<B>Result Construction</B> is a higher level concern than stream manipulation. Likely will be the user of stream manipulation where applicable.<BR>
While the return values of such methods are easy to define, the parameters are not. Some commands parse streams, some local files, some use a webservice or local library api.<BR>
Example can be seen within the Stream manipulation example <A href="stream-manipulation-code-examples.html#Streammanipulationcodeexamples-ExampleUsecase">here</A></P>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Collapsing%28%26Clustering%29"></A>Collapsing (&amp; Clustering)</H3>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Modifiers"></A>Modifiers</H3>

<P>Defined in an auxiliary interface, eg NavigatableSearchCommand.<BR>
Modifiers today are generic, built from the Navigator which holds the configuration, and the search command's results.<BR>
Defined behavior by an interface would result in the FastNavigationController becoming a ModifierNavigationController.</P>

<P>I do not see a need for delegation in the design as in most cases the parsing of the information required to construct the modifiers is specific to the search command.<BR>
Keep in mind that this is a subset to the Result Construction concern.</P>

<H3><A name="NewdesignproposalforSearchCommandandAbstractSearchCommand-Utilitybehavior"></A>Utility behavior</H3>

<P>Stay as is. Actual static methods can be moved to a SearchCommandUtility class.</P>
        </DIV>
                  <DIV class="tabletitle">
            Children
            <SPAN class="smalltext" id="show" style="display: inline;">
              <A href="javascript:showChildren()">Show Children</A></SPAN>
            <SPAN class="smalltext" id="hide" style="display: none;">
              <A href="javascript:hideChildren()">Hide Children</A></SPAN>
          </DIV>
          <DIV class="greybox" id="children" style="display: none;">
                                      <A href="stream-manipulation-code-examples.html" title="Stream manipulation code examples">Stream manipulation code examples</A>
              <SPAN class="smalltext">(Sesat)</SPAN>
              <BR>
                          <A href="searchcommandparameter-code-example.html" title="SearchCommandParameter code example">SearchCommandParameter code example</A>
              <SPAN class="smalltext">(Sesat)</SPAN>
              <BR>
                          <A href="querybuilder-code-example.html" title="QueryBuilder code example">QueryBuilder code example</A>
              <SPAN class="smalltext">(Sesat)</SPAN>
              <BR>
                      </DIV>
              </DIV>

    <DIV style="clear: both;">
      <DIV style="float: left;">&nbsp;&copy; 2007-2009 <A href="http://schibsted.com/">Schibsted ASA</A></DIV>
      <DIV style="float: right;"><A href="mailto:mick@semb.wever.org">Contact</A>&nbsp;us</DIV>
    </DIV>

   </DIV>
</DIV>
</HTML>
