
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
  <HEAD>
    <LINK type="text/css" rel="stylesheet" href="resources/space.css">
    <STYLE type="text/css">

#PageContent {
	text-align: left;
	background-color: #fff;
	padding: 0px;
	margin: 0px;
    padding-bottom:20px; 
}

#TopTable {
    height: 104px; width: 100%; 
    background-image: url(/sunrise3.JPG); 
    background-repeat: no-repeat; 
    background-position: center;
}

div > #TopTable {
    position: fixed; z-index: 1; 
}

div > #PageContent {
    position: relative; 
    top: 114px;
}

      .footer {
        background-image:      url('/images/border/border_bottom.gif');
        background-repeat:     repeat-x;
        background-position:   left top;
        padding-top:           4px;
        color:                 #666;
      }
body, p, td, table, tr, .bodytext, .stepfield {
  font-family:          Trebuchet MS, Tahoma, sans-serif;
  font-size:            14px;
  margin:               0px;
  padding:              0px;
  padding-right:30px;
}
#leftColumn{
  float: left; 
  align: left; 
  text-align: left; 
  width: 13%; 
  border-right: solid lightgrey; 
  border-right-width:1px;
}
#leftColumn h5{
  text-decoration: none;
  color: #6B6965;
  font-size:            18px;
  font-weight: bold;
}
#leftColumn li a{
  text-decoration: none;
  color: #6B6965;
  font-weight: bold;
}
#leftColumn a:hover, #leftColumn a.active  {
  color: #1678C4;
  background-color: #F7EEDB;
}
#TopTable a{
  text-decoration: none;
  font-weight: bold;
}
    </STYLE>
    <SCRIPT type="text/javascript" language="javascript">
      var hide = null;
      var show = null;
      var children = null;

      function init() {

        /* Children initialization */
        hide = document.getElementById('hide');
        show = document.getElementById('show');
        children = document.all != null ?
                   document.all['children'] :
                   document.getElementById('children');
        if (children != null) {
          children.style.display = 'none';
          show.style.display = 'inline';
          hide.style.display = 'none';
        }
      }

      function showChildren() {
        children.style.display = 'block';
        show.style.display = 'none';
        hide.style.display = 'inline';
      }

      function hideChildren() {
        children.style.display = 'none';
        show.style.display = 'inline';
        hide.style.display = 'none';
      }
    </SCRIPT>
    <TITLE>HowTo Solr Query Evaluation</TITLE>
  <META http-equiv="Content-Type" content="text/html;charset=UTF-8"></HEAD>
  <BODY onload="init()" style="background-color: #fff;">
<DIV>
    <TABLE id="TopTable" border="0" cellpadding="2" cellspacing="0" width="100%">
      <TR valign="bottom">
        <TD align="left" valign="bottom" class="topBarDiv" align="left" nowrap="">
          <!--img src="https://michaelsembwever.github.io/Possom/sesat- black- logo.png" border="0"-->&nbsp;<A href="home.html" title="Sesat">Sesat</A>&nbsp;&gt;&nbsp;<A href="docs-support.html" title="Docs + Support">Docs + Support</A>&nbsp;&gt;&nbsp;<A href="" title="HowTo Solr Query Evaluation">HowTo Solr Query Evaluation</A>
        </TD>
        <TD align="right" valign="bottom" nowrap="">
          <FORM name="search" action="http://sesam.com/search/" method="get" onsubmit="getElementById('searchformq').value = getElementById('searchformq').value + ' site:sesat.no'; return true">
            <INPUT type="text" name="q" maxlength="255" value="" id="searchformq">        
            <INPUT type="submit" name="btnG" value="Search">
          </FORM>
        </TD>
      </TR> 
    </TABLE>
    <DIV id="PageContent">

<DIV id="leftColumn">
<H5 style="margin-top: -2px;">Get Sesat</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/product-whitepaper.html">
What is Sesat?</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/download.html" style="decorator-style: none;">
Download</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/kernel-feature-list.html">
Features</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/showcases-sesamno.html">
Screenshots</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/free-software-license.html">
License</A>
</LI>
</UL>

<H5>Documentation</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/development-guidelines.html">
Getting Started</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/tutorial-building-sesamcom.html">
Sesam.com tutorial</A>
</LI>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/faq.html">
FAQ</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
&nbsp;...<A href="https://michaelsembwever.github.io/Possom/docs-support.html">more</A>
</LI>
</UL>
<H5>Development</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/kernel-roadmap.html">
Roadmap</A>
</LI>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/svn/">
Subversion Repository</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/getting-help.html">
Mailing lists</A>
</LI>
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/scarab/issues">
Issues</A>
</LI>
<!--LI class="none" style="list- style: none; margin- left: - 30px;">
<A href="https://michaelsembwever.github.io/Possom/hudson/">
Hudson
</A>
</LI>
<LI class="none" style="list- style: none; margin- left: - 30px;">
<A href="https://michaelsembwever.github.io/Possom/source/">
OpenGrok
</A>
</LI-->
</UL>

<H5>Projects</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/">Search Framework</A><BR>
<A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/sesat-core-api">Search Library</A><BR>
<A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/sesat-mojo/">Mojo</A><BR>
<A href="https://michaelsembwever.github.io/Possom/projects/sesat-admin/sesat-user">User Service</A>
</LI>
</UL>

<H5>Commons</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="http://commons-ioc.sourceforge.net/">Contextual IoC</A><BR>
<A href="https://michaelsembwever.github.io/Possom/projects/sesat-commons/commons-interpreter/">Interpreter</A><BR>
<A href="http://commons-reflect.sourceforge.net/">Reflection</A><BR>
<A href="http://commons-ref-map.sourceforge.net/">Reference Map</A><BR>
<A href="http://commons-visitor.sourceforge.net/">Visitor</A><BR>
</LI>
</UL>


<H5>Sitemap</H5>
<UL style="margin-top: -4px;">
<LI class="none" style="list-style: none; margin-left: -30px;">
<A href="https://michaelsembwever.github.io/Possom/sitemap.html">Sitemap</A><BR>
</LI>
</UL>
</DIV>

      <DIV class="pagecontent" style="width: 83%; float: right;">
        <DIV class="wiki-content">
          <DIV class="panelMacro"><TABLE class="infoMacro"><COLGROUP><COL width="24"><COL></COLGROUP><TR><TD valign="top"><IMG src="http://confluence.finn.no/images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></TD><TD><B>associated to</B><BR><A href="https://michaelsembwever.github.io/Possom/scarab/issues/id/SKER4952" rel="nofollow">https://michaelsembwever.github.io/Possom/scarab/issues/id/SKER4952</A></TD></TR></TABLE></DIV>

<H1><A name="HowToSolrQueryEvaluation-SettingupSesat%27sQueryEvaluationwithaSolrindex"></A>Setting up Sesat's Query Evaluation with a Solr index</H1>

<H5><A name="HowToSolrQueryEvaluation-Preface"></A>Preface</H5>

<P>&nbsp; Sesat comes with a query evaluation that occurs during the query parsing stage. Its purpose is to evaluate metadata against each clause (leaf and operator) within the currently constructed Query tree. The evaluation has various types. <BR clear="all"></P>

<P>&nbsp; Current implementations are clauses matching regular expressions (<A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/xref/no/sesat/search/query/token/RegExpTokenEvaluator.html" rel="nofollow">RegExpTokenEvaluator</A>), mathematical expressions (<A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/xref/no/sesat/search/query/token/JepTokenEvaluator.html" rel="nofollow">JepTokenEvaluator</A>), hits against a FAST Query Matching server (<A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/xref/no/sesat/search/query/token/VeryFastTokenEvaluator.html" rel="nofollow">VeryFastTokenEvaluator</A>), and hits against a Solr server (<A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/xref/no/sesat/search/query/token/SolrTokenEvaluator.html" rel="nofollow">SolrTokenEvaluator</A>).  <BR clear="all"></P>

<P>&nbsp; Some examples of metadata used at sesam.no are first_name, last_name, full_name, company_name, english_words, geological_province, geological_city, geological_suburb, and geological_street. All of these metadata examples are stored in a Solr index as some of them are very large, eg the full_name list contains the national register of the norwegian population - roughly 5 million names.  <BR clear="all"></P>

<P>&nbsp; After the Query tree has been constructed, and the metadata associated to each clause, this can be used to maximise the efficiently of which searches to execute and end up federating. For example there is no need for us to initiate a search against our 'white pages' (or people catalogue) if neither a full_name, or first_name + last_name combination, metadata exists within the query. Another example is our 'yellow pages' (or company catalogue) searches can be enhanced when we know which clauses within query are geological terms. <BR clear="all"></P>

<P>&nbsp; It can be seen why we, at <A href="http://sesam.no/" rel="nofollow">sesam.no</A>, see this query evaluation as a crucial part of a federating search engine.</P>

<H5><A name="HowToSolrQueryEvaluation-Introduction"></A>Introduction</H5>

<P>Our query evaluation against large data lists used to be via the (<A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/xref/no/sesat/search/query/token/VeryFastTokenEvaluator.html" rel="nofollow">VeryFastTokenEvaluator</A>) that works against a FAST Query Matching server. In a desire to move away from a proprietary closed solution that left us at the mercy of FAST consultants and towards an open solution that we fully owned and were free to share we decided to re-implement all this functionality with a Solr index. What follows is our installation and setup of a Solr index to successfully work with our (<A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/xref/no/sesat/search/query/token/SolrTokenEvaluator.html" rel="nofollow">SolrTokenEvaluator</A>) using the english_words metadata as the example.</P>

<H5><A name="HowToSolrQueryEvaluation-Configuration"></A>Configuration</H5>

<P>In Sesat's base skin &quot;generic.sesam&quot; you'll find war/src/main/conf/SolrEvaluators.xml containing:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">&lt;solr-evaluators&gt;
    &lt;list token=<SPAN class="code-quote">&quot;ENGLISHWORDS&quot;</SPAN> list-name=<SPAN class="code-quote">&quot;common_english&quot;</SPAN>/&gt;
 &lt;/solr-evaluators&gt;
</PRE>
</DIV></DIV>

<P>This declares the metadata (also referred to as a Token or TokenPredicate) ENGLISHWORDS, and connects it to hits in the solr index with list_name=common_english.<BR>
This is all that is required to setup evaluation for english_words metadata.</P>

<P>We also need to configure where the Solr index can be found.<BR>
In the same skin you'll find war/src/main/conf/configuration.properties with the line:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">tokenevaluator.solr.serverUrl=@tokenevaluator.solr.serverUrl@
</PRE>
</DIV></DIV>

<P>The @tokenevaluator.solr.serverUrl@ is filtered from values defined in the skin's pom.xml according to the current profile in action.<BR>
For the development profile this reads:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">&lt;tokenevaluator.solr.serverUrl&gt;http:<SPAN class="code-comment">//localhost:16000/solr&lt;/tokenevaluator.solr.serverUrl&gt;</SPAN>
</PRE>
</DIV></DIV>
<P>So you can either run Solr locally on port 16000 or create a ssh tunnel on your port 16000 to another Solr server.<BR>
Note: the values for the other profiles point to a host &quot;sch-solr-test01.dev.osl.basefarm.net&quot;. This is our own Solr server and so naturally won't work for you - you'll need to override this setting.</P>

<P>Along with this configuration it's now presumed that you have sesat skin up and running. If you don't read <A href="tutorial-building-sesamcom.html" title="Tutorial - Building Sesam.com">Tutorial &#45; Building Sesam.com</A> for help on how to.</P>

<H5><A name="HowToSolrQueryEvaluation-SolrInstallation"></A>Solr Installation</H5>

<P>You'll need a recent version of Solr, 1.4, or latter, so that the two patches found in <A href="https://issues.apache.org/jira/browse/LUCENE-1380" rel="nofollow">https://issues.apache.org/jira/browse/LUCENE-1380</A> and <A href="https://issues.apache.org/jira/browse/SOLR-763" rel="nofollow">https://issues.apache.org/jira/browse/SOLR-763</A> are included.</P>

<P>Deploy the solr.war to your container. Before starting it you'll need to configure your Solr Home.<BR>
It is fine to use the example Solr home found in example/solr but replacing schema.xml with:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java">&lt;?xml version=<SPAN class="code-quote">&quot;1.0&quot;</SPAN> encoding=<SPAN class="code-quote">&quot;UTF-8&quot;</SPAN> ?&gt;
&lt;schema name=<SPAN class="code-quote">&quot;example&quot;</SPAN> version=<SPAN class="code-quote">&quot;1.1&quot;</SPAN>&gt;
  &lt;types&gt;
    &lt;fieldType name=<SPAN class="code-quote">&quot;string&quot;</SPAN> class=<SPAN class="code-quote">&quot;solr.StrField&quot;</SPAN> sortMissingLast=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> omitNorms=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>/&gt;
    &lt;fieldType name=<SPAN class="code-quote">&quot;date&quot;</SPAN> class=<SPAN class="code-quote">&quot;solr.DateField&quot;</SPAN> sortMissingLast=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> omitNorms=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>/&gt;
   &lt;fieldType name=<SPAN class="code-quote">&quot;shingleString&quot;</SPAN> class=<SPAN class="code-quote">&quot;solr.TextField&quot;</SPAN> positionIncrementGap=<SPAN class="code-quote">&quot;100&quot;</SPAN> omitNorms=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>&gt;
      &lt;analyzer type=<SPAN class="code-quote">&quot;index&quot;</SPAN>&gt;
        &lt;tokenizer class=<SPAN class="code-quote">&quot;solr.KeywordTokenizerFactory&quot;</SPAN>/&gt;
      &lt;/analyzer&gt;
      &lt;analyzer type=<SPAN class="code-quote">&quot;query&quot;</SPAN>&gt;
        &lt;tokenizer class=<SPAN class="code-quote">&quot;solr.WhitespaceTokenizerFactory&quot;</SPAN>/&gt;
        &lt;filter class=<SPAN class="code-quote">&quot;solr.ShingleFilterFactory&quot;</SPAN> outputUnigrams=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> outputUnigramIfNoNgram=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> maxShingleSize=<SPAN class="code-quote">&quot;99&quot;</SPAN> enablePositions=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">false</SPAN>&quot;</SPAN> /&gt;
      &lt;/analyzer&gt;
    &lt;/fieldType&gt;
    &lt;fieldtype name=<SPAN class="code-quote">&quot;ignored&quot;</SPAN> stored=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">false</SPAN>&quot;</SPAN> indexed=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">false</SPAN>&quot;</SPAN> class=<SPAN class="code-quote">&quot;solr.StrField&quot;</SPAN> /&gt; 
 &lt;/types&gt;


 &lt;fields&gt;
   &lt;field name=<SPAN class="code-quote">&quot;id&quot;</SPAN> type=<SPAN class="code-quote">&quot;string&quot;</SPAN> stored=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> required=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> /&gt; 
   &lt;field name=<SPAN class="code-quote">&quot;list_name&quot;</SPAN> type=<SPAN class="code-quote">&quot;string&quot;</SPAN> indexed=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> stored=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>/&gt;
   &lt;field name=<SPAN class="code-quote">&quot;list_entry&quot;</SPAN> type=<SPAN class="code-quote">&quot;string&quot;</SPAN> indexed=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> stored=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>/&gt;
   &lt;field name=<SPAN class="code-quote">&quot;list_entry_shingle&quot;</SPAN> type=<SPAN class="code-quote">&quot;shingleString&quot;</SPAN> indexed=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> stored=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>/&gt;
   &lt;field name=<SPAN class="code-quote">&quot;list_entry_synonym&quot;</SPAN> type=<SPAN class="code-quote">&quot;string&quot;</SPAN> indexed=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> stored=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN>/&gt;
   &lt;field name=<SPAN class="code-quote">&quot;timestamp&quot;</SPAN> type=<SPAN class="code-quote">&quot;date&quot;</SPAN> indexed=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> stored=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">true</SPAN>&quot;</SPAN> <SPAN class="code-keyword">default</SPAN>=<SPAN class="code-quote">&quot;NOW&quot;</SPAN> multiValued=<SPAN class="code-quote">&quot;<SPAN class="code-keyword">false</SPAN>&quot;</SPAN>/&gt;
 &lt;/fields&gt;

 &lt;uniqueKey&gt;id&lt;/uniqueKey&gt;
 &lt;defaultSearchField&gt;list_entry_shingle&lt;/defaultSearchField&gt;
 &lt;solrQueryParser defaultOperator=<SPAN class="code-quote">&quot;OR&quot;</SPAN>/&gt;
&lt;/schema&gt;
</PRE>
</DIV></DIV>

<P>Now start the container and unzip and feed in the solr xml document <A href="howto-solr-query-evaluation.data/add_english_words.xml.gz">add_english_words.xml.gz</A> that contains all the english words.</P>

<H5><A name="HowToSolrQueryEvaluation-Codingwiththemetadata%3ATokenPredicates"></A>Coding with the metadata: TokenPredicates</H5>

<P>Everything should now work.</P>

<P>When a query is parsed <A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/apidocs/no/sesat/search/query/WordClause.html" rel="nofollow">WordClause</A>s within the Query that match one of the english words with contain within the clause's knownPredicates list the <A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/apidocs/no/sesat/search/query/token/TokenPredicate.html" rel="nofollow">TokenPredicate</A> <A href="https://michaelsembwever.github.io/Possom/projects/sesat-kernel/apidocs/no/sesat/search/query/token/Categories.html" rel="nofollow">ENGLISHWORDS</A>. For example:</P>
<DIV class="code panel" style="border-width: 1px;"><DIV class="codeContent panelContent">
<PRE class="code-java"><SPAN class="code-keyword">true</SPAN> == clause.containsKnownPredicate(Categories.ENGLISHWORDS)</PRE>
</DIV></DIV>

<H5><A name="HowToSolrQueryEvaluation-KnownandPossiblePredicates%3F"></A>Known and Possible Predicates?</H5>

<P>What is a possible predicate?</P>

<P>Sometimes metadata is position dependent, that is the position of the term within the query has the final say whether the metadata is really applicable. This can be used with the regular expression evaluators, but also every TokenPredicate has an &quot;exactPeer&quot; which is only ever true if the whole query has the metadata. We cannot assign such metadata definitely to the root clause of any query because clauses are immutable and used in a fly-weight pattern across multiple Query trees.</P>
        </DIV>
              </DIV>

    <DIV style="clear: both;">
      <DIV style="float: left;">&nbsp;&copy; 2007-2009 <A href="http://schibsted.com/">Schibsted ASA</A></DIV>
      <DIV style="float: right;"><A href="mailto:mick@semb.wever.org">Contact</A>&nbsp;us</DIV>
    </DIV>

   </DIV>
</DIV>
</HTML>
